@model HazelInvoice.Models.Purchase
@using System.Text.Json
@using HazelInvoice.Models

@{
    ViewData["Title"] = "New Purchase";
    var suppliers = ViewBag.Suppliers as List<Supplier> ?? new List<Supplier>();
    var products = ViewBag.Products as List<Product> ?? new List<Product>();
    var purchaseDate = (Model?.Date ?? DateTime.Today).ToString("yyyy-MM-dd");
}

<div class="container-fluid p-4">
    <div class="card shadow-lg border-0 rounded-4">
        <div class="card-header bg-dark text-white p-3 rounded-top-4">
            <h4 class="mb-0"><i class="bi bi-cart-plus"></i> New Purchase</h4>
        </div>
        <div class="card-body bg-light">
            <form asp-action="Create" method="post" id="purchaseForm">
                <div asp-validation-summary="ModelOnly" class="text-danger"></div>

                <div class="row g-3 mb-4">
                    <div class="col-md-3">
                        <label asp-for="Date" class="form-label fw-bold">Date</label>
                        <input asp-for="Date" type="date" class="form-control" value="@purchaseDate" />
                        <span asp-validation-for="Date" class="text-danger"></span>
                    </div>
                    <div class="col-md-5">
                        <label class="form-label fw-bold">Supplier</label>
                        <select class="form-select" id="supplierSelect">
                            <option value="">-- New / Manual Supplier --</option>
                            @foreach (var s in suppliers)
                            {
                                <option value="@s.Id" data-name="@s.Name" data-address="@s.Address" data-contact="@s.ContactNumber">@s.Name</option>
                            }
                        </select>
                        <input type="hidden" asp-for="SupplierId" id="supplierId" />
                        <span asp-validation-for="SupplierId" class="text-danger"></span>
                    </div>
                    <div class="col-md-4">
                        <label asp-for="SupplierName" class="form-label fw-bold">Supplier Name</label>
                        <input asp-for="SupplierName" class="form-control" id="supplierName" placeholder="Enter supplier name" />
                        <span asp-validation-for="SupplierName" class="text-danger"></span>
                    </div>
                    <div class="col-md-6">
                        <label asp-for="SupplierAddress" class="form-label fw-bold">Address <span class="text-muted fw-normal">(Optional)</span></label>
                        <input asp-for="SupplierAddress" class="form-control" id="supplierAddress" placeholder="Supplier address" />
                    </div>
                    <div class="col-md-6">
                        <label asp-for="ContactNumber" class="form-label fw-bold">Contact No. <span class="text-muted fw-normal">(Optional)</span></label>
                        <input asp-for="ContactNumber" class="form-control" id="supplierContact" placeholder="Contact number" />
                    </div>
                </div>

                <div class="table-responsive mb-4 bg-white p-3 rounded-3 shadow-sm">
                    <table class="table table-hover align-middle" id="itemsTable">
                        <thead class="table-light">
                            <tr>
                                <th style="width: 36%">Item</th>
                                <th style="width: 12%">Quantity</th>
                                <th style="width: 12%">Unit</th>
                                <th style="width: 14%">Cost</th>
                                <th style="width: 14%">Amount</th>
                                <th style="width: 6%"></th>
                            </tr>
                        </thead>
                        <tbody id="itemsBody">
                        </tbody>
                        <tfoot>
                            <tr>
                                <td colspan="6">
                                    <button type="button" class="btn btn-outline-primary btn-sm" onclick="addItemRow()">
                                        <i class="bi bi-plus-lg"></i> Add Item
                                    </button>
                                </td>
                            </tr>
                        </tfoot>
                    </table>
                </div>

                <div class="row g-3 justify-content-end">
                    <div class="col-md-4">
                        <div class="card bg-white shadow-sm">
                            <div class="card-body">
                                <div class="d-flex justify-content-between mb-2">
                                    <span class="fw-bold">Total Amount:</span>
                                    <h4 class="text-primary mb-0" id="totalAmountDisplay">0.00</h4>
                                    <input type="hidden" asp-for="TotalAmount" id="totalAmountInput" />
                                </div>
                                <div class="d-flex justify-content-between align-items-center mb-2">
                                    <span class="fw-bold">Paid:</span>
                                    <input asp-for="PaidAmount" class="form-control form-control-sm text-end w-50" value="0.00" />
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="mt-3">
                    <label asp-for="Notes" class="form-label fw-bold">Notes <span class="text-muted fw-normal">(Optional)</span></label>
                    <textarea asp-for="Notes" class="form-control" rows="2" placeholder="Remarks or additional notes"></textarea>
                </div>

                <div class="mt-4 text-end">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="bi bi-check2-circle"></i> Save Purchase
                    </button>
                    <a asp-action="Index" class="btn btn-light ms-2">Cancel</a>
                </div>
            </form>
        </div>
    </div>
</div>

<script>
    var productData = @Html.Raw(JsonSerializer.Serialize(products));
    var rowIndex = 0;

    function addItemRow() {
        var optionsHtml = '<option value="">-- Select Item --</option>';
        if (productData.length > 0) {
            productData.forEach(function (p) {
                var cleanName = p.Name.replace(/"/g, '&quot;');
                optionsHtml += `<option value="${p.Id}" data-unit="${p.Unit}" data-cost="${p.UnitCost}">${cleanName}</option>`;
            });
        }
        optionsHtml += '<option value="__other__">Other (manual)</option>';

        var html = `
            <tr id="row_${rowIndex}">
                <td>
                    <select class="form-select item-select" onchange="itemChanged(this, ${rowIndex})" required>
                        ${optionsHtml}
                    </select>
                    <input type="hidden" name="Lines[${rowIndex}].ProductId" id="prodId_${rowIndex}" />
                    <input type="hidden" name="Lines[${rowIndex}].ItemName" id="itemName_${rowIndex}" />
                    <input type="text" class="form-control mt-2 d-none" id="customName_${rowIndex}" placeholder="Enter item name" oninput="customNameChanged(${rowIndex})" />
                </td>
                <td>
                    <input type="number" name="Lines[${rowIndex}].Quantity" class="form-control text-center" value="1" min="1" onchange="calculateRow(${rowIndex})" required />
                </td>
                <td>
                    <select name="Lines[${rowIndex}].Unit" id="unit_${rowIndex}" class="form-select text-center" required>
                        <option value="kg">kg</option>
                        <option value="pcs">pcs</option>
                        <option value="pack">pack</option>
                        <option value="bundle">bundle</option>
                        <option value="box">box</option>
                        <option value="sack">sack</option>
                        <option value="tray">tray</option>
                    </select>
                </td>
                <td>
                    <input type="number" step="0.01" name="Lines[${rowIndex}].Cost" id="cost_${rowIndex}" class="form-control text-end" onchange="calculateRow(${rowIndex})" required />
                </td>
                <td>
                    <input type="number" step="0.01" name="Lines[${rowIndex}].Amount" id="amount_${rowIndex}" class="form-control text-end" readonly />
                </td>
                <td>
                    <button type="button" class="btn btn-danger btn-sm" onclick="removeRow(${rowIndex})"><i class="bi bi-trash"></i></button>
                </td>
            </tr>
        `;

        document.getElementById('itemsBody').insertAdjacentHTML('beforeend', html);
        rowIndex++;
    }

    function removeRow(index) {
        var row = document.getElementById(`row_${index}`);
        if (row) row.remove();
        calculateTotal();
    }

    function itemChanged(select, index) {
        var option = select.options[select.selectedIndex];
        var customInput = document.getElementById(`customName_${index}`);

        if (!option || !option.value) {
            document.getElementById(`prodId_${index}`).value = '';
            document.getElementById(`itemName_${index}`).value = '';
            customInput.classList.add('d-none');
            return;
        }

        if (option.value === '__other__') {
            document.getElementById(`prodId_${index}`).value = '';
            document.getElementById(`itemName_${index}`).value = '';
            customInput.value = '';
            customInput.classList.remove('d-none');
            return;
        }

        customInput.classList.add('d-none');
        document.getElementById(`prodId_${index}`).value = option.value;
        document.getElementById(`itemName_${index}`).value = option.text;

        var unit = option.getAttribute('data-unit');
        var cost = parseFloat(option.getAttribute('data-cost')) || 0;
        if (unit) document.getElementById(`unit_${index}`).value = unit;
        document.getElementById(`cost_${index}`).value = cost.toFixed(2);
        calculateRow(index);
    }

    function customNameChanged(index) {
        var customInput = document.getElementById(`customName_${index}`);
        document.getElementById(`itemName_${index}`).value = customInput.value;
    }

    function calculateRow(index) {
        var qtyInput = document.querySelector(`input[name="Lines[${index}].Quantity"]`);
        var costInput = document.getElementById(`cost_${index}`);
        if (!qtyInput || !costInput) return;

        var qty = parseFloat(qtyInput.value) || 0;
        var cost = parseFloat(costInput.value) || 0;
        var amount = qty * cost;

        document.getElementById(`amount_${index}`).value = amount.toFixed(2);
        calculateTotal();
    }

    function calculateTotal() {
        var total = 0;
        document.querySelectorAll('input[id^="amount_"]').forEach(function (inp) {
            total += parseFloat(inp.value) || 0;
        });
        document.getElementById('totalAmountDisplay').innerText = total.toFixed(2);
        document.getElementById('totalAmountInput').value = total.toFixed(2);
    }

    function onSupplierChange() {
        var select = document.getElementById('supplierSelect');
        var option = select.options[select.selectedIndex];
        var supplierIdInput = document.getElementById('supplierId');
        var supplierNameInput = document.getElementById('supplierName');
        var supplierAddressInput = document.getElementById('supplierAddress');
        var supplierContactInput = document.getElementById('supplierContact');

        if (!option || !option.value) {
            supplierIdInput.value = '';
            supplierNameInput.readOnly = false;
            supplierNameInput.value = '';
            supplierAddressInput.value = '';
            supplierContactInput.value = '';
            return;
        }

        supplierIdInput.value = option.value;
        supplierNameInput.value = option.getAttribute('data-name') || option.text;
        supplierNameInput.readOnly = true;

        var addr = option.getAttribute('data-address') || '';
        var contact = option.getAttribute('data-contact') || '';
        if (!supplierAddressInput.value) supplierAddressInput.value = addr;
        if (!supplierContactInput.value) supplierContactInput.value = contact;
    }

    document.addEventListener('DOMContentLoaded', function () {
        document.getElementById('supplierSelect').addEventListener('change', onSupplierChange);
        addItemRow();
    });
</script>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
}
